<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æœ€å°å”¯ä¸€æ•¸éŠæˆ² - ä¸»æ§ç•«é¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="/socket.io/socket.io.js"></script>
  
  <!-- å¼•å…¥ Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #020617;
      --bg-gradient-main:
        radial-gradient(circle at 10% -10%, rgba(248,250,252,0.18), transparent 60%),
        radial-gradient(circle at 90% 0%, rgba(248,113,113,0.3), transparent 60%),
        radial-gradient(circle at 10% 120%, rgba(22,163,74,0.32), transparent 60%),
        linear-gradient(to top, #020617 0%, #020617 40%, #020617 100%);

      --card-bg: rgba(15, 23, 42, 0.9);
      --card-border: rgba(148, 163, 184, 0.18);

      --primary: #16a34a;          /* è–èª•ç¶  */
      --primary-hover: #22c55e;
      --danger: #ef4444;           /* è–èª•ç´… */
      --danger-hover: #dc2626;
      --success: #22c55e;
      --text-main: #f9fafb;
      --text-sub: #9ca3af;
      --gold: #facc15;
      --gold-bg: rgba(250, 204, 21, 0.16);

      --shadow-sm: 0 1px 3px 0 rgba(15, 23, 42, 0.8);
      --shadow-lg: 0 18px 40px rgba(0,0,0,0.8), 0 0 0 1px rgba(15,23,42,0.9);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg-gradient-main);
      color: var(--text-main);
      padding: 20px;
      position: relative;
      overflow: hidden;
    }

    /* é£„é›ªæ•ˆæœ */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image:
        radial-gradient(2px 2px at 10% 20%, rgba(255,255,255,0.9), transparent),
        radial-gradient(2px 2px at 30% 80%, rgba(255,255,255,0.8), transparent),
        radial-gradient(2px 2px at 50% 10%, rgba(255,255,255,0.9), transparent),
        radial-gradient(2px 2px at 70% 60%, rgba(255,255,255,0.85), transparent),
        radial-gradient(2px 2px at 90% 30%, rgba(255,255,255,0.9), transparent);
      background-size: 220px 260px;
      opacity: 0.7;
      animation: snow 18s linear infinite;
      mix-blend-mode: screen;
      z-index: 0;
    }

    @keyframes snow {
      0%   { transform: translateY(-40px); }
      100% { transform: translateY(40px); }
    }

    /* å…¨å±€ Layout å¤–å†åŒ…ä¸€å±¤å ´æ™¯ï¼Œç”¨ä¾†æ”¾è–èª•è£é£¾ */
    .scene-wrapper {
      max-width: 1240px;
      margin: 0 auto;
      display: flex;
      gap: 16px;
      align-items: stretch;
      position: relative;
      z-index: 1;
    }

    .scene-side {
      width: 40px;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-size: 24px;
      opacity: 0.95;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.7));
    }

    @media (min-width: 1024px) {
      .scene-side { display: flex; }
    }

    .layout {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
      position: relative;
    }

    /* Layout ä¸Šæ–¹æ›ç‡ˆæ¢ */
    .layout::before {
      content: "";
      position: absolute;
      left: -4px;
      right: -4px;
      top: -4px;
      height: 26px;
      background-image:
        radial-gradient(circle at 5% 40%, #f97373 0, #f97373 4px, transparent 4px),
        radial-gradient(circle at 25% 40%, #facc15 0, #facc15 4px, transparent 4px),
        radial-gradient(circle at 45% 40%, #4ade80 0, #4ade80 4px, transparent 4px),
        radial-gradient(circle at 65% 40%, #38bdf8 0, #38bdf8 4px, transparent 4px),
        radial-gradient(circle at 85% 40%, #fb7185 0, #fb7185 4px, transparent 4px);
      background-size: 120px 28px;
      background-repeat: repeat-x;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.9));
      pointer-events: none;
    }

    /* Header & Stats Dashboard */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      padding-top: 10px;
    }

    h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
      background: linear-gradient(to right, #f97373, #facc15, #22c55e);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    h1 .icon {
      font-size: 30px;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.8));
    }

    .tag {
      background: rgba(15, 23, 42, 0.9);
      color: var(--gold);
      padding: 4px 10px;
      border-radius: 99px;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid rgba(250, 204, 21, 0.4);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .tag::before {
      content: "ğŸ›ï¸";
      font-size: 13px;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    .stat-card {
      background:
        radial-gradient(circle at 0% 0%, rgba(248,250,252,0.08), transparent 45%),
        var(--card-bg);
      backdrop-filter: blur(14px);
      border: 1px solid var(--card-border);
      border-radius: 18px;
      padding: 14px 16px 12px;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
    }

    .stat-card::after {
      content: "";
      position: absolute;
      right: -10px;
      bottom: -10px;
      width: 60px;
      height: 60px;
      background: radial-gradient(circle, rgba(250,204,21,0.25), transparent 60%);
      opacity: 0.8;
      pointer-events: none;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-main);
      display: flex;
      align-items: baseline;
      gap: 4px;
    }
    
    .stat-value.highlight { color: var(--gold); }
    .stat-value.alive { color: var(--success); }

    /* Control Panel */
    .control-panel {
      display: flex;
      flex-direction: column;
      gap: 16px;
      background:
        linear-gradient(145deg, rgba(15,23,42,0.98), rgba(15,23,42,0.9));
      backdrop-filter: blur(14px);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: 18px 20px 16px;
      box-shadow: var(--shadow-lg);
      position: relative;
      overflow: hidden;
    }

    .control-panel::before {
      content: "ğŸ„ æ§åˆ¶è–èª•æ´¾å°ç¯€å¥";
      position: absolute;
      right: 16px;
      top: 10px;
      font-size: 11px;
      color: var(--text-sub);
      opacity: 0.85;
    }

    .control-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
    }

    .input-group {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(15, 23, 42, 0.7);
      padding: 6px 8px 6px 14px;
      border-radius: 999px;
      border: 1px solid var(--card-border);
      min-height: 38px;
    }

    .input-group span {
      font-size: 13px;
      color: var(--text-sub);
      white-space: nowrap;
    }

    input[type="number"],
    input[type="password"] {
      background: transparent;
      border: none;
      color: white;
      font-size: 14px;
      width: 80px;
      outline: none;
      font-weight: 600;
    }
    
    input::placeholder { color: rgba(148,163,184,0.4); }

    /* Buttons */
    .btn {
      padding: 8px 16px;
      font-size: 13px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      letter-spacing: 0.02em;
      position: relative;
      overflow: hidden;
    }

    .btn::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 10% 0%, rgba(248,250,252,0.26), transparent 55%);
      opacity: 0;
      transition: opacity 0.15s ease-out;
      pointer-events: none;
    }

    .btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      filter: grayscale(1);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-hover));
      color: white;
      box-shadow: 0 4px 14px rgba(22, 163, 74, 0.6);
    }
    .btn-primary:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(22, 163, 74, 0.8);
      filter: brightness(1.03);
      opacity: 0.98;
    }
    .btn-primary:not(:disabled):hover::after {
      opacity: 1;
    }

    .btn-danger {
      background: rgba(248, 113, 113, 0.15);
      color: var(--danger);
      border: 1px solid rgba(248, 113, 113, 0.4);
    }
    .btn-danger:not(:disabled):hover {
      background: linear-gradient(135deg, var(--danger), var(--danger-hover));
      color: white;
      box-shadow: 0 4px 14px rgba(248, 113, 113, 0.6);
    }

    .btn-secondary {
      background: rgba(15,23,42,0.8);
      color: var(--text-main);
      border: 1px solid var(--card-border);
    }
    .btn-secondary:hover:not(:disabled) {
      background: rgba(30,64,175,0.35);
      border-color: rgba(191,219,254,0.8);
    }

    /* Main Content Layout */
    .content-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      align-items: start;
    }

    @media (max-width: 900px) {
      .content-grid { grid-template-columns: 1fr; }
    }

    .card {
      background:
        linear-gradient(150deg, rgba(15,23,42,0.96), rgba(15,23,42,0.9));
      backdrop-filter: blur(14px);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: 18px 18px 16px;
      display: flex;
      flex-direction: column;
      max-height: 80vh;
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      left: -40px;
      top: -40px;
      width: 120px;
      height: 120px;
      background: radial-gradient(circle, rgba(248,250,252,0.1), transparent 70%);
      opacity: 0.8;
      pointer-events: none;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--card-border);
    }

    .card-header h2 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--text-main);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .card-header h2::before {
      content: "ğŸ";
      font-size: 16px;
    }

    .card-header span {
      font-size: 12px;
      color: var(--text-sub);
    }

    /* Alerts / Messages */
    .message-box {
      margin-bottom: 12px;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 13px;
      line-height: 1.5;
      display: none;
    }
    .message-box.active { display: block; }

    #waiting {
      background: rgba(248, 250, 252, 0.02);
      border: 1px dashed rgba(148,163,184,0.5);
      color: #e5e7eb;
    }

    #result {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
      color: #6ee7b7;
      min-height: auto;
    }

    /* Table Styles */
    .table-container {
      overflow-y: auto;
      flex: 1;
      border-radius: 10px;
      border: 1px solid var(--card-border);
      background: rgba(15,23,42,0.75);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th {
      background: rgba(15, 23, 42, 0.98);
      color: var(--text-sub);
      font-weight: 500;
      padding: 10px 12px;
      text-align: left;
      position: sticky;
      top: 0;
      z-index: 5;
      backdrop-filter: blur(4px);
      box-shadow: 0 1px 0 var(--card-border);
    }
    
    th:last-child, td:last-child { text-align: right; }

    td {
      padding: 9px 12px;
      border-bottom: 1px solid var(--card-border);
      color: var(--text-main);
    }

    tr:last-child td { border-bottom: none; }
    
    .eliminated-row {
      background: rgba(15,23,42,0.9);
      color: #64748b;
    }
    .eliminated-row td { opacity: 0.65; }

    .winner {
      background: linear-gradient(to right, rgba(250, 204, 21, 0.1), transparent);
      position: relative;
    }
    .winner td {
      color: #fbbf24;
      font-weight: 600;
    }
    .winner td:first-child::before {
      content: 'ğŸ‘‘';
      margin-right: 6px;
    }

    /* Badges in Table */
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      background: rgba(255,255,255,0.06);
      color: var(--text-sub);
    }
    .badge-success { background: rgba(22, 163, 74, 0.18); color: #4ade80; }
    .badge-danger { background: rgba(248, 113, 113, 0.18); color: #fb7185; }
    .badge-wait { background: rgba(59, 130, 246, 0.18); color: #60a5fa; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.25); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(148, 163, 184, 0.5); }

    @media (max-width: 640px) {
      body { padding: 12px; }
      .card { max-height: none; }
    }

    /* æŠŠæ’­æ”¾å™¨ç¸®å°æ”¾åœ¨è§’è½ï¼Œæ¸›å°‘å¹²æ“¾ */
    #player-wrapper {
      position: fixed;
      bottom: 10px;
      right: 10px;
      width: 200px;   /* è¦éµå®ˆ YouTube æ¢æ¬¾å°±ä¸è¦è¨­å¤ªå° */
      height: 113px;  /* 16:9 æ¯”ä¾‹ */
      z-index: 9999;
    }

    #bg-music-btn {
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div class="scene-wrapper">
  <!-- å·¦å´è–èª•è£é£¾ -->
  <div class="scene-side">
    <span>ğŸ…</span>
    <span>ğŸ„</span>
    <span>ğŸ¦Œ</span>
  </div>

  <div class="layout">
    <!-- æ¨™é¡Œ -->
    <header>
      <h1>
        <span class="icon">ğŸ„</span>
        æœ€å°å”¯ä¸€æ•¸éŠæˆ²
        <span class="tag">ä¸»æ§ç«¯</span>
      </h1>
    </header>

    <!-- æ•¸æ“šå„€è¡¨æ¿ -->
    <div class="stats-grid">
      <div class="stat-card">
        <span class="stat-label">ç•¶å‰è¼ªæ¬¡</span>
        <span class="stat-value highlight" id="roundDisplay">-</span>
      </div>
      <div class="stat-card">
        <span class="stat-label">ç¸½ç©å®¶æ•¸</span>
        <span class="stat-value" id="statsPlayers">-</span>
      </div>
      <div class="stat-card">
        <span class="stat-label">å­˜æ´» / åƒè³½</span>
        <span class="stat-value alive" id="statsActive">-</span>
      </div>
      <div class="stat-card">
        <span class="stat-label">éŠæˆ²ç‹€æ…‹</span>
        <span class="stat-value" id="statsStateText" style="font-size: 18px; margin-top: 4px;">ç­‰å¾…ä¸­</span>
      </div>
    </div>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="control-panel">
      <!-- ä¸Šæ’ï¼šè¨­å®šèˆ‡ç™»å…¥ -->
      <div class="control-row">
        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
          <div class="input-group">
            <span>ç®¡ç†å¯†ç¢¼</span>
            <input type="password" id="adminPwd" />
            <button class="btn btn-secondary btn-sm" id="btnAdminLogin">ç™»å…¥</button>
          </div>
          <div class="input-group">
            <span>ç©å®¶äººæ•¸</span>
            <input type="number" id="playerCountInput" min="1" placeholder="32" />
            <button class="btn btn-secondary btn-sm" id="btnSetCount">è¨­å®š</button>
          </div>
          <button id="bg-music-btn">æ’­æ”¾èƒŒæ™¯éŸ³æ¨‚</button>

          <div id="player-wrapper" style="display: none;">
            <div id="player"></div>
          </div>
        </div>
      </div>
      
      <!-- ä¸‹æ’ï¼šä¸»è¦å‹•ä½œ -->
      <div class="control-row" style="border-top: 1px solid var(--card-border); padding-top: 16px; justify-content: flex-end;">
        <button class="btn btn-primary" id="btnNextRound" disabled style="min-width: 210px; padding: 10px 24px; font-size: 15px;">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M5 3l14 9-14 9V3z"/></svg>
          é–‹å§‹ä¸‹ä¸€è¼ª / é–‹å§‹éŠæˆ²
        </button>
        <button class="btn btn-danger" id="btnResetGame" disabled>
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
          é‡ç½®éŠæˆ²
        </button>
      </div>
    </div>

    <!-- å…§å®¹å€å¡Š -->
    <div class="content-grid">
      <!-- å·¦å´ï¼šç©å®¶ç‹€æ…‹ -->
      <div class="card">
        <div class="card-header">
          <h2>ç©å®¶å¯¦æ™‚ç‹€æ…‹</h2>
          <span>å³æ™‚ç›£æ§ç©å®¶é¸æ“‡èˆ‡å­˜æ´»æƒ…æ³</span>
        </div>

        <!-- è¨Šæ¯æç¤ºå€ -->
        <div id="result" class="message-box"></div>
        <div id="waiting" class="message-box"></div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th width="10%">ID</th>
                <th width="25%">æš±ç¨±</th>
                <th width="15%">ç‹€æ…‹</th>
                <th width="15%">é€²åº¦</th>
                <th width="20%">å·²é¸æ•¸å­—</th>
                <th width="15%" style="text-align: right;">æœ¬è¼ª</th>
              </tr>
            </thead>
            <tbody id="playerRows"></tbody>
          </table>
        </div>
      </div>

      <!-- å³å´ï¼šæ­·å²ç´€éŒ„ -->
      <div class="card">
        <div class="card-header">
          <h2>æ­·å²ç´€éŒ„</h2>
          <span>æ¯è¼ªå‹å‡ºçµæœ</span>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>è¼ªæ¬¡</th>
                <th style="text-align: right;">çµæœ / å‹è€…</th>
              </tr>
            </thead>
            <tbody id="historyBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- å³å´è–èª•è£é£¾ -->
  <div class="scene-side">
    <span>ğŸ</span>
    <span>â­</span>
    <span>ğŸ§‘â€ğŸ„</span>
  </div>
</div>

<!-- éš±è—çš„èˆŠ ID ä¿æŒå…¼å®¹æ€§ -->
<div id="round" style="display: none;"></div>
<div id="summaryPlayers" style="display: none;"></div>
<div id="summaryActive" style="display: none;"></div>
<div id="summaryState" style="display: none;"></div>
<!-- 1. è¼‰å…¥ YouTube iframe API -->
<script src="https://www.youtube.com/iframe_api"></script>
<script>
    const socket = io();
    
    // UI Elements Mapped to new Structure
    const roundDisplay = document.getElementById('roundDisplay');
    const statsPlayers = document.getElementById('statsPlayers');
    const statsActive = document.getElementById('statsActive');
    const statsStateText = document.getElementById('statsStateText');

    const playerRows = document.getElementById('playerRows');
    const resultDiv = document.getElementById('result');
    const waitingDiv = document.getElementById('waiting');
    const btnNextRound = document.getElementById('btnNextRound');
    const btnResetGame = document.getElementById('btnResetGame');
    const adminPwdInput = document.getElementById('adminPwd');
    const btnAdminLogin = document.getElementById('btnAdminLogin');
    const historyBody = document.getElementById('historyBody');
    const playerCountInput = document.getElementById('playerCountInput');
    const btnSetCount = document.getElementById('btnSetCount');

    // Logic Variables
    let lastState = null;
    let isAdmin = false;

    // --- Socket Events ---

    socket.on('stateUpdate', (state) => {
      lastState = state;
      renderState();
    });

    socket.on('roundResult', (result) => {
      showResult(result.message);
    });

    socket.on('newRound', (data) => {
      showResult(`ç¬¬ ${data.round} è¼ªé–‹å§‹ï¼Œè«‹ç©å®¶é‡æ–°é¸æ“‡æ•¸å­—ã€‚`, true);
    });

    socket.on('gameReset', () => {
      showResult('éŠæˆ²å·²é‡ç½®ï¼Œç­‰å¾…é‡æ–°è¨­å®šäººæ•¸èˆ‡ç©å®¶é‡æ–°åŠ å…¥ã€‚');
      waitingDiv.classList.remove('active');
      waitingDiv.textContent = '';
    });

    socket.on('adminStatus', (res) => {
      if (res.ok) {
        isAdmin = true;
        adminPwdInput.disabled = true;
        btnAdminLogin.disabled = true;
        btnAdminLogin.textContent = 'å·²ç™»å…¥';
        btnAdminLogin.classList.replace('btn-secondary', 'btn-primary');
        showResult('å·²ç™»å…¥ä¸»æ§ï¼Œå¯ä»¥é–‹å§‹éŠæˆ² / ä¸‹ä¸€è¼ªã€‚', true);
        updateButtons();
      } else {
        alert(res.error || 'ç®¡ç†ç™»å…¥å¤±æ•—');
      }
    });

    // --- Event Listeners ---

    btnAdminLogin.addEventListener('click', () => {
      const pwd = adminPwdInput.value;
      socket.emit('registerAdmin', pwd);
    });

    btnSetCount.addEventListener('click', () => {
      const val = parseInt(playerCountInput.value, 10);
      if (!Number.isInteger(val) || val <= 0) {
        alert('è«‹è¼¸å…¥å¤§æ–¼ 0 çš„æ•´æ•¸äººæ•¸ã€‚');
        return;
      }
      socket.emit('setPlayerCount', val);
    });

    btnNextRound.addEventListener('click', () => {
      if (!isAdmin) return;
      socket.emit('startNextRound');
    });

    btnResetGame.addEventListener('click', () => {
      if (!isAdmin) return;
      if (confirm('ç¢ºå®šè¦é‡ç½®æ•´å ´éŠæˆ²å—ï¼Ÿæ‰€æœ‰ç©å®¶èˆ‡ç´€éŒ„éƒ½æœƒè¢«æ¸…ç©ºã€‚')) {
        socket.emit('resetGame');
      }
    });

    // --- Render Functions ---

    function showResult(msg, isPositive = false) {
      resultDiv.textContent = msg;
      resultDiv.classList.add('active');
      if(!isPositive && msg.includes('é‡ç½®')) {
          resultDiv.style.borderColor = 'rgba(239, 68, 68, 0.3)';
          resultDiv.style.color = '#fca5a5';
      } else {
          resultDiv.style.borderColor = 'rgba(16, 185, 129, 0.2)';
          resultDiv.style.color = '#6ee7b7';
      }
    }

    function renderState() {
      if (!lastState) return;

      // 1. Update Dashboard Stats
      if (lastState.round > 0) {
        roundDisplay.textContent = lastState.round;
      } else {
        roundDisplay.textContent = '-';
      }

      statsPlayers.textContent = lastState.joinedCount ?? 0;
      if (lastState.maxPlayers != null) {
        statsPlayers.textContent += ` / ${lastState.maxPlayers}`;
      }

      statsActive.textContent = lastState.activeCount ?? 0;

      // Update State Text & Color
      if (lastState.round === 0) {
        statsStateText.textContent = 'è¨­å®šä¸­';
        statsStateText.style.color = 'var(--text-sub)';
      } else if (lastState.roundActive) {
        statsStateText.textContent = 'é€²è¡Œä¸­';
        statsStateText.style.color = 'var(--success)';
      } else if (lastState.choicesVisible) {
        statsStateText.textContent = 'çµç®—å®Œç•¢';
        statsStateText.style.color = 'var(--gold)';
      } else {
        statsStateText.textContent = 'æš«åœ';
        statsStateText.style.color = 'var(--text-sub)';
      }

      // 2. Update Player Table
      playerRows.innerHTML = '';
      const winners = lastState.winners || [];
      const choicesVisible = lastState.choicesVisible;
      const waitingNamesNickname = [];
      const waitingNamesChoice = [];

      lastState.players.forEach(p => {
        const tr = document.createElement('tr');
        
        const tdId = document.createElement('td');
        const tdName = document.createElement('td');
        const tdStatus = document.createElement('td');
        const tdProgress = document.createElement('td');
        const tdHist = document.createElement('td');
        const tdCurrent = document.createElement('td');

        tdId.textContent = `#${p.id}`;
        
        const nameSpan = document.createElement('span');
        nameSpan.textContent = p.name || `ç©å®¶ ${p.id}`;
        if(p.name) nameSpan.style.color = 'white';
        tdName.appendChild(nameSpan);

        if (p.eliminated) {
            tdStatus.innerHTML = '<span class="badge badge-danger">å·²æ·˜æ±°</span>';
            tr.classList.add('eliminated-row');
        } else {
            tdStatus.innerHTML = '<span class="badge badge-success">å­˜æ´»</span>';
        }

        if (!p.hasName) {
            tdProgress.innerHTML = '<span class="badge">ç„¡æš±ç¨±</span>';
        } else if (!p.eliminated) {
            if (p.choice != null) {
                tdProgress.innerHTML = '<span class="badge badge-success">å·²é¸</span>';
            } else {
                tdProgress.innerHTML = '<span class="badge badge-wait">æ€è€ƒä¸­</span>';
            }
        } else {
            tdProgress.textContent = '-';
        }

        if (choicesVisible && p.choice != null) {
          tdCurrent.textContent = p.choice;
          tdCurrent.style.fontWeight = 'bold';
          tdCurrent.style.fontSize = '1.1em';
        } else {
          tdCurrent.textContent = '-';
        }

        tdHist.textContent = p.eliminated ? '-' : (p.choice != null ? 'ğŸ”’ å·²é–å®š' : '...');
        tdHist.style.fontSize = '12px';
        tdHist.style.color = 'var(--text-sub)';

        if (!p.hasName && !p.eliminated) {
          waitingNamesNickname.push(p.name || `ID:${p.id}`);
        } else if (!p.eliminated && p.hasName && p.choice == null && lastState.round > 0 && !choicesVisible) {
          waitingNamesChoice.push(p.name || `ID:${p.id}`);
        }

        if (winners.includes(p.id)) {
          tr.classList.add('winner');
        }

        tr.appendChild(tdId);
        tr.appendChild(tdName);
        tr.appendChild(tdStatus);
        tr.appendChild(tdProgress);
        tr.appendChild(tdHist);
        tr.appendChild(tdCurrent);
        playerRows.appendChild(tr);
      });

      // 3. Update Waiting Message
      if (waitingNamesNickname.length > 0) {
        waitingDiv.textContent = 'ç­‰å¾…è¼¸å…¥æš±ç¨±ï¼š' + waitingNamesNickname.join('ã€');
        waitingDiv.classList.add('active');
      } else if (waitingNamesChoice.length > 0 && !choicesVisible) {
        waitingDiv.textContent = 'ç­‰å¾…é¸æ“‡æ•¸å­—ï¼š' + waitingNamesChoice.join('ã€');
        waitingDiv.classList.add('active');
      } else {
        waitingDiv.textContent = '';
        waitingDiv.classList.remove('active');
      }

      // 4. History
      renderHistory(lastState.history || []);
      updateButtons();
    }

    function renderHistory(history) {
      historyBody.innerHTML = '';
      history.forEach(h => {
        const tr = document.createElement('tr');
        const tdRound = document.createElement('td');
        const tdResult = document.createElement('td');

        tdRound.innerHTML = `<span class="badge">R ${h.round}</span>`;
        
        if (!h.hasWinner) {
          tdResult.textContent = 'ç„¡äººç²å‹';
          tdResult.style.color = 'var(--text-sub)';
        } else {
          const names = h.winnerNames && h.winnerNames.length
              ? h.winnerNames.join(', ')
              : `ID ${h.winnerIds.join(', ')}`;
          
          tdResult.innerHTML = `
            <span style="color:var(--text-sub)">æœ€å°å”¯ä¸€æ•¸</span> 
            <strong style="color:var(--primary); margin:0 4px;">${h.lowestUnique}</strong>
            <br>
            <span style="font-size:12px; color:var(--gold)">ğŸ† ${names} (æ·˜æ±°)</span>
          `;
        }

        tr.appendChild(tdRound);
        tr.appendChild(tdResult);
        historyBody.appendChild(tr);
      });
    }

    function updateButtons() {
      if (lastState && lastState.round === 0) {
        btnSetCount.disabled = false;
        playerCountInput.disabled = false;
        playerCountInput.parentNode.style.opacity = '1';
      } else {
        btnSetCount.disabled = true;
        playerCountInput.disabled = true;
        playerCountInput.parentNode.style.opacity = '0.5';
      }

      if (!isAdmin) {
        btnNextRound.disabled = true;
        btnResetGame.disabled = true;
        return;
      }

      btnNextRound.disabled = false;
      btnResetGame.disabled = false;
    }

    // æ’­æ”¾èƒŒæ™¯éŸ³æ¨‚
    let player;
    let hasPlayed = false;

    // 2. API è¼‰å…¥å¾Œæœƒè‡ªå‹•å‘¼å«é€™å€‹å‡½æ•¸
    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '113',
        width: '200',
        videoId: 'fyEAX7Cd3OE', // ä¾‹å¦‚ 'dQw4w9WgXcQ'
        playerVars: {
          autoplay: 0,      // å…ˆä¸è¦è‡ªå‹•æ’­
          controls: 0,      // ä¸é¡¯ç¤ºæ§åˆ¶åˆ—
          rel: 0,
          modestbranding: 1
        },
        events: {
          onReady: onPlayerReady
        }
      });
    }

    // 3. ç©å®¶æº–å‚™å¥½å¾Œï¼Œç¶å®šæŒ‰éˆ•äº‹ä»¶
    function onPlayerReady() {
      const btn = document.getElementById('bg-music-btn');
      btn.addEventListener('click', function () {
        // ç¬¬ä¸€æ¬¡é»æ“Šï¼šé¡¯ç¤ºæ’­æ”¾å™¨ä¸¦æ’­æ”¾
        document.getElementById('player-wrapper').style.display = 'block';
        player.playVideo();
        hasPlayed = true;
        btn.textContent = 'æš«åœèƒŒæ™¯éŸ³æ¨‚';
      });

      btn.addEventListener('click', function () {
        if (!hasPlayed) return; // ä¿éšª

        const state = player.getPlayerState();
        if (state === YT.PlayerState.PLAYING) {
          player.pauseVideo();
          btn.textContent = 'æ’­æ”¾èƒŒæ™¯éŸ³æ¨‚';
        } else {
          player.playVideo();
          btn.textContent = 'æš«åœèƒŒæ™¯éŸ³æ¨‚';
        }
      });
    }
</script>
</body>
</html>
