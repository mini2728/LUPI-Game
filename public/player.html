<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æœ€å°å”¯ä¸€æ•¸ - é—œå¡é¢¨æ ¼</title>
  <!-- Viewport è¨­å®š -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <script src="/socket.io/socket.io.js"></script>
  
  <!-- å¼•å…¥å¡é€šåœ“é«” -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Titan+One&family=Nunito:wght@600;800&display=swap" rel="stylesheet">

  <style>
    :root {
      /* åƒè€ƒåœ–ç‰‡é…è‰² */
      --panel-bg: #fdf5e6;       /* ç±³é»ƒè‰²åº•æ¿ */
      --panel-border: #d4b483;   /* æ·±ç±³è‰²é‚Šæ¡† */
      
      --ribbon-green: #81c784;   /* çµ²å¸¶ç¶  (æ·º) */
      --ribbon-dark: #4caf50;    /* çµ²å¸¶ç¶  (æ·±) */
      
      --btn-base: #fceabb;       /* æŒ‰éˆ•åº•è‰² */
      --btn-border: #e6c68b;     /* æŒ‰éˆ•æ·±è‰²é‚Šæ¡† */
      --btn-text: #ffffff;
      
      --btn-locked: #cfd8dc;     /* é–å®š/ç¦ç”¨ç°è‰² */
      --btn-locked-border: #90a4ae;

      --accent-yellow: #fbc02d;  /* é»ƒè‰²æŒ‰éˆ•/è£é£¾ */
      --accent-orange: #f57f17;  /* æ·±æ©˜é™°å½± */

      --text-stroke: #5d4037;    /* æ–‡å­—æ·±è‰²æé‚Š */
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      min-height: 100dvh;
      font-family: 'Nunito', system-ui, sans-serif;
      /* èƒŒæ™¯ï¼šæ·¡è—è‰²æ ¼å­åœ–æ¡ˆï¼Œè®“ç±³è‰²é¢æ¿æ›´çªå‡º */
      background-color: #e0f7fa;
      background-image: 
        linear-gradient(45deg, #b2ebf2 25%, transparent 25%, transparent 75%, #b2ebf2 75%, #b2ebf2), 
        linear-gradient(45deg, #b2ebf2 25%, transparent 25%, transparent 75%, #b2ebf2 75%, #b2ebf2);
      background-size: 40px 40px;
      background-position: 0 0, 20px 20px;
      
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      overflow: hidden;
    }

    /* === ä¸»é¢æ¿ (The Board) === */
    .game-board {
      width: 100%;
      max-width: 460px;
      background: var(--panel-bg);
      border: 6px solid var(--panel-border);
      border-radius: 30px;
      padding: 40px 20px 24px 20px; /* Top padding ç•™çµ¦çµ²å¸¶ */
      position: relative;
      box-shadow: 
        inset 0 0 20px rgba(212, 180, 131, 0.4),
        0 10px 20px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 95dvh;
    }

    /* å·¦å³å…©å´çš„å°èºçµ²è£é£¾ (æ¨¡ä»¿åœ–ç‰‡è§’è½) */
    .game-board::after, .game-board::before {
      content: 'âœ–';
      position: absolute;
      top: 15px;
      color: #e6c68b;
      font-size: 14px;
      font-weight: bold;
    }
    .game-board::before { left: 15px; }
    .game-board::after { right: 15px; }

    /* === ç¶ è‰²çµ²å¸¶æ¨™é¡Œ (Ribbon Header) === */
    .ribbon-container {
      position: absolute;
      top: 0px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      max-width: 300px;
      z-index: 10;
      filter: drop-shadow(0 4px 2px rgba(0,0,0,0.15));
    }

    .ribbon-main {
      background: linear-gradient(to bottom, #a5d6a7, #66bb6a);
      height: 50px;
      width: 100%;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      
      /* è£½ä½œå¼§å½¢çµ²å¸¶æ•ˆæœ */
      clip-path: polygon(
        0% 10%, 5% 0%, 95% 0%, 100% 10%, /* ä¸Šç·£å¾®ç¸® */
        100% 80%, 90% 100%, 10% 100%, 0% 80% /* ä¸‹ç·£å¼§ç·š */
      );
    }

    .ribbon-text {
      font-family: 'Titan One', cursive;
      color: white;
      font-size: 26px;
      /* æ–‡å­—æé‚Šæ•ˆæœ */
      -webkit-text-stroke: 1.5px #2e7d32; 
      text-shadow: 0 2px 0 rgba(0,0,0,0.1);
      letter-spacing: 1px;
      white-space: nowrap;
    }

    /* çµ²å¸¶å…©å´çš„æŠ˜è§’ (è£é£¾) */
    .ribbon-fold-left, .ribbon-fold-right {
      position: absolute;
      top: 10px;
      width: 30px;
      height: 30px;
      background: #388e3c;
      z-index: -1;
    }
    .ribbon-fold-left { left: -10px; clip-path: polygon(100% 0, 0 50%, 100% 100%); }
    .ribbon-fold-right { right: -10px; clip-path: polygon(0 0, 100% 50%, 0 100%); }


    /* === è³‡è¨Šæ¬„ä½ === */
    .info-bar {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
    
    .status-badge {
      background: #fff;
      border: 2px solid var(--panel-border);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 20px;
      color: #8d6e63;
      font-weight: 800;
      box-shadow: 0 2px 0 rgba(0,0,0,0.05);
    }
    .status-badge.highlight {
      color: var(--ribbon-dark);
    }

    /* === ç‹€æ…‹æ–‡å­—å€ === */
    .message-box {
      text-align: center;
      min-height: 40px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    #status {
      font-weight: 700;
      color: #5d4037;
      font-size: 15px;
    }
    #extraHint {
      font-size: 12px;
      color: #8d6e63;
      margin-top: 2px;
    }

    /* === æš±ç¨±è¼¸å…¥ (æ¨¡ä»¿å½ˆçª—è¼¸å…¥) === */
    #nameForm {
      display: flex;
      gap: 8px;
      background: rgba(255,255,255,0.6);
      padding: 8px;
      border-radius: 16px;
      border: 2px dashed var(--panel-border);
    }
    
    input[type="text"] {
      flex: 1;
      border: 2px solid var(--panel-border);
      border-radius: 12px;
      padding: 8px 12px;
      font-family: 'Nunito', sans-serif;
      font-weight: 700;
      color: #5d4037;
      outline: none;
      background: #fff;
    }

    /* é»ƒè‰²åœ“å½¢æŒ‰éˆ• (åƒåœ–ç‰‡å³ä¸‹è§’çš„è³¼ç‰©è»ŠæŒ‰éˆ•) */
    .btn-circle-action {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #fff176, var(--accent-yellow));
      border: 2px solid white;
      box-shadow: 
        0 0 0 2px var(--accent-orange), /* å¤–åœˆæ©˜æ¡† */
        0 4px 0 var(--accent-orange),   /* ä¸‹æ–¹ç«‹é«”é™°å½± */
        0 6px 5px rgba(0,0,0,0.2);
      color: white;
      font-weight: 900;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.1s;
      padding: 0;
    }
    .btn-circle-action:active {
      transform: translateY(4px);
      box-shadow: 0 0 0 2px var(--accent-orange);
    }
    .btn-circle-action::before {
      content: 'OK';
      -webkit-text-stroke: 1px #e65100;
      font-family: 'Titan One', cursive;
    }

    /* === æ•¸å­—ç¶²æ ¼ (Level Grid) === */
    .grid-wrapper {
      flex: 1;
      overflow-y: auto;
      padding: 4px;
      /* éš±è—æ»¾å‹•æ¢ */
      scrollbar-width: none;
    }
    .grid-wrapper::-webkit-scrollbar { display: none; }

    .number-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
      gap: 12px;
      padding-bottom: 10px;
    }

    /* === é—œå¡æ–¹å¡ŠæŒ‰éˆ• === */
    .num-btn {
      aspect-ratio: 1;
      background: var(--btn-base);
      border: none;
      border-radius: 14px;
      position: relative;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.1s;
      
      /* ç«‹é«”æ•ˆæœæ ¸å¿ƒ */
      box-shadow: 
        inset 0 0 0 3px #fff, /* å…§ç™½æ¡† */
        0 6px 0 var(--btn-border), /* ä¸‹æ–¹åšåº¦ */
        0 10px 10px rgba(0,0,0,0.1);
      
      font-family: 'Titan One', cursive;
      font-size: 26px;
      color: white;
      -webkit-text-stroke: 1.5px #5d4037; /* å¡é€šæé‚Š */
    }

    /* è£é£¾æ˜Ÿæ˜Ÿ (æ¨¡ä»¿åœ–ç‰‡ä¸­çš„æ˜Ÿç´š) */
    .num-btn::after {
      content: 'â˜…â˜…â˜…';
      position: absolute;
      bottom: 6px;
      font-size: 10px;
      color: #ffd54f;
      -webkit-text-stroke: 0.5px #bf360c;
      letter-spacing: 1px;
    }

    /* æŒ‰ä¸‹æ•ˆæœ */
    .num-btn:active:not(:disabled) {
      transform: translateY(6px); /* å¾€ä¸‹å£“ */
      box-shadow: inset 0 0 0 3px #fff, 0 0 0 var(--btn-border); /* é™°å½±æ¶ˆå¤± */
    }

    /* é¸ä¸­ç‹€æ…‹ (è®Šæˆé‡‘è‰²/æ©˜è‰²) */
    .num-btn.selected {
      background: var(--accent-yellow);
      box-shadow: 
        inset 0 0 0 3px #fff,
        0 6px 0 var(--accent-orange),
        0 10px 10px rgba(0,0,0,0.1);
    }

    /* ç¦ç”¨/é–å®šç‹€æ…‹ (ç°è‰²) */
    .num-btn:disabled {
      background: var(--btn-locked);
      box-shadow: 
        inset 0 0 0 3px #eceff1,
        0 6px 0 var(--btn-locked-border);
      cursor: not-allowed;
      opacity: 0.8;
    }
    /* é–é ­åœ–ç¤º (è¦†è“‹åœ¨ç¦ç”¨æŒ‰éˆ•ä¸Š) */
    .num-btn:disabled::before {
      content: 'ğŸ”’';
      position: absolute;
      top: 4px;
      right: 4px;
      font-size: 10px;
      -webkit-text-stroke: 0;
      filter: grayscale(1);
    }

    /* å·¦å³ç®­é ­è£é£¾ (ç´”è¦–è¦ºï¼Œæ¨¡ä»¿åœ–ç‰‡ç¿»é éˆ•) */
    .nav-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 30px;
      height: 30px;
      background: #eceff1;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 3px 0 #b0bec5;
      font-weight: bold;
      color: #78909c;
      z-index: 5;
    }
    .nav-arrow.left { left: -15px; }
    .nav-arrow.right { right: -15px; background: var(--accent-yellow); color: white; box-shadow: 0 3px 0 var(--accent-orange); }

  </style>
</head>
<body>

  <!-- çµ²å¸¶æ¨™é¡Œ (æ”¾åœ¨ Board å¤–é¢æˆ–çµ•å°å®šä½) -->
  <div class="ribbon-container">
    <div class="ribbon-fold-left"></div>
    <div class="ribbon-fold-right"></div>
    <div class="ribbon-main">
      <div class="ribbon-text">Level Select</div>
    </div>
  </div>

  <div class="game-board">

    <!-- è³‡è¨Šæ¬„ -->
    <div class="info-bar">
      <div class="status-badge" id="roundPill">æº–å‚™ä¸­</div>
      <div class="status-badge highlight" id="playerInfo">é€£ç·šä¸­...</div>
    </div>

    <!-- è¨Šæ¯ç‹€æ…‹ -->
    <div class="message-box">
      <div id="status">æ­£åœ¨è®€å–...</div>
      <div id="extraHint"></div>
    </div>

    <!-- æš±ç¨±è¼¸å…¥ -->
    <div id="nameForm" style="display:none;">
      <input type="text" id="nickname" placeholder="è¼¸å…¥ç©å®¶åç¨±" maxlength="10" />
      <button id="btnSetName" class="btn-circle-action"></button>
    </div>

    <!-- æ•¸å­—ç¶²æ ¼ -->
    <div class="grid-wrapper">
      <div id="gridContainer" class="number-grid"></div>
    </div>

  </div>

  <script>
    // ==== é‚è¼¯ä¿æŒä¸è®Š ====
    const CLIENT_KEY = 'lowestUniqueClientId';
    function getClientId() {
      let id = localStorage.getItem(CLIENT_KEY);
      if (!id) {
        id = 'p-' + Math.random().toString(36).slice(2) + Date.now().toString(36);
        localStorage.setItem(CLIENT_KEY, id);
      }
      return id;
    }

    const socket = io({
      auth: {
        clientId: getClientId()
      }
    });

    let playerId = null;
    let hasChosen = false;
    let minNumber = 1;
    let maxNumber = 32;
    let hasName = false;
    let eliminated = false;
    let lastState = null;
    const NICK_KEY = 'lowestUniqueNickname';

    const playerInfoDiv = document.getElementById('playerInfo');
    const roundPill = document.getElementById('roundPill'); // åŸ roundInfoDiv æ”¹ç”¨æ­¤é¡¯ç¤º
    const statusDiv = document.getElementById('status');
    const gridContainer = document.getElementById('gridContainer');
    const nameFormDiv = document.getElementById('nameForm');
    const nicknameInput = document.getElementById('nickname');
    const btnSetName = document.getElementById('btnSetName');
    const extraHint = document.getElementById('extraHint');

    const savedNick = localStorage.getItem(NICK_KEY);
    if (savedNick) {
      nicknameInput.value = savedNick;
    }

    socket.on('playerInfo', (info) => {
      playerId = info.playerId;
      minNumber = info.minNumber;
      maxNumber = info.maxNumber;

      playerInfoDiv.textContent = info.name;
      if (!nicknameInput.value) {
        nicknameInput.value = info.name;
      }

      buildButtons();
      
      if (savedNick) {
        socket.emit('setName', savedNick);
        hasName = true;
        nameFormDiv.style.display = 'none'; // Auto hide
        statusDiv.textContent = 'å·²å°±ä½ï¼Œç­‰å¾…é–‹å§‹ï¼';
        extraHint.textContent = 'è«‹ç­‰å¾…æŒ‡ä»¤';
        refreshButtonsEnabled();
      } else {
        nameFormDiv.style.display = 'flex';
        statusDiv.textContent = 'æ–°ç©å®¶ï¼Ÿè«‹è¼¸å…¥åå­—';
      }
    });

    socket.on('spectator', () => {
      playerInfoDiv.textContent = 'è§€çœ¾';
      statusDiv.textContent = 'ç„¡æ³•åŠ å…¥ (è§€æˆ°æ¨¡å¼)';
      roundPill.textContent = 'Spectator';
      gridContainer.innerHTML = '';
      nameFormDiv.style.display = 'none';
    });

    socket.on('stateUpdate', (state) => {
      lastState = state;

      if (state.round > 0) {
        roundPill.textContent = `Round ${state.round}`;
      } else {
        if (state.maxPlayers != null) {
          roundPill.textContent = `ç­‰å¾… (${state.joinedCount}/${state.maxPlayers})`;
        } else {
          roundPill.textContent = 'ç­‰å¾…è¨­å®š';
        }
      }

      if (playerId != null) {
        const me = state.players.find(p => p.id === playerId);
        if (me) {
          playerInfoDiv.textContent = me.name;
          hasName = !!me.hasName;
          eliminated = !!me.eliminated;
          
          if (!hasName) nameFormDiv.style.display = 'flex';
          else nameFormDiv.style.display = 'none';

          if (eliminated) {
            statusDiv.innerHTML = '<span style="color:#d84315">é—–é—œæˆåŠŸ (å·²é›¢å ´)</span>';
            extraHint.textContent = 'ä½ å·²æ˜¯è´å®¶ï¼Œè«‹ä¼‘æ¯ä¸€ä¸‹';
            
          } else if (me.choice != null) {
            hasChosen = true;
            // Visual feedback
            highlightButton(me.choice);

            if (state.choicesVisible) {
              statusDiv.innerHTML = `ä½ é¸äº†: <strong style="color:#e65100; font-size:1.2em">${me.choice}</strong>`;
            } else {
              statusDiv.textContent = 'å·²é¸æ“‡ï¼Œç­‰å¾…é–‹ç...';
            }
            extraHint.textContent = '';
          } else {
            hasChosen = false;
            // Clear highlights
            document.querySelectorAll('.num-btn').forEach(b => b.classList.remove('selected'));

            if (!hasName) {
              statusDiv.textContent = 'è«‹è¼¸å…¥åå­—';
            } else if (state.round === 0) {
              statusDiv.textContent = 'ç­‰å¾…éŠæˆ²é–‹å§‹...';
              extraHint.textContent = 'Ready?';
            } else if (!state.roundActive) {
              statusDiv.textContent = 'å›åˆçµæŸ / æš«åœ';
              extraHint.textContent = 'Wait...';
            } else {
              statusDiv.textContent = 'è«‹é¸æ“‡ä¸€å€‹é—œå¡(æ•¸å­—)!';
              extraHint.textContent = 'Choose your number';
            }
          }
        }
      }

      refreshButtonsEnabled();
    });

    socket.on('roundResult', (result) => {
      if (playerId != null && result.winners && result.winners.includes(playerId)) {
        statusDiv.innerHTML = `ğŸ‰ <strong>WINNER!</strong> ${result.lowestUnique}`;
        extraHint.textContent = 'æ­å–œéé—œï¼';
      }
      refreshButtonsEnabled();
    });

    socket.on('newRound', (data) => {
      if (playerId != null && !eliminated) {
        hasChosen = false;
        refreshButtonsEnabled();
        document.querySelectorAll('.num-btn').forEach(b => b.classList.remove('selected'));
      }
    });

    socket.on('gameReset', () => {
      statusDiv.innerHTML = '<span style="color:red">éŠæˆ²é‡ç½®</span>';
      extraHint.textContent = 'Reloading...';
      gridContainer.innerHTML = '';
      btnSetName.disabled = true;
      setTimeout(() => location.reload(), 2000);
    });

    btnSetName.addEventListener('click', () => {
      const name = nicknameInput.value.trim();
      if (!name) {
        alert('æš±ç¨±ä¸èƒ½æ˜¯ç©ºçš„');
        return;
      }
      socket.emit('setName', name);
      hasName = true;
      localStorage.setItem(NICK_KEY, name);
      statusDiv.textContent = 'åå­—å·²è¨­å®š';
      refreshButtonsEnabled();
    });

    function buildButtons() {
      gridContainer.innerHTML = '';
      for (let n = minNumber; n <= maxNumber; n++) {
        const btn = document.createElement('button');
        btn.className = 'num-btn'; // å°æ‡‰ CSS
        btn.textContent = n;
        btn.dataset.value = n;
        btn.addEventListener('click', () => chooseNumber(n));
        gridContainer.appendChild(btn);
      }
    }

    function chooseNumber(n) {
      if (hasChosen) return;
      if (!hasName) {
        alert('è«‹å…ˆè¼¸å…¥åå­—');
        nicknameInput.focus();
        return;
      }
      if (eliminated) {
        alert('ä½ å·²éé—œ(æ·˜æ±°)ï¼Œä¸èƒ½å†é¸');
        return;
      }
      if (!lastState || !lastState.roundActive) {
        alert('ç¾åœ¨é‚„ä¸èƒ½é¸');
        return;
      }

      const ok = confirm(`é¸æ“‡é—œå¡ ${n} ï¼Ÿ\n(é¸å®šå¾Œç„¡æ³•æ›´æ”¹)`);
      if (!ok) return;

      socket.emit('chooseNumber', n);
      hasChosen = true;
      highlightButton(n);
      refreshButtonsEnabled();
    }

    function highlightButton(n) {
        const btn = document.querySelector(`.num-btn[data-value="${n}"]`);
        if(btn) btn.classList.add('selected');
    }

    function refreshButtonsEnabled() {
      const buttons = Array.from(gridContainer.querySelectorAll('button'));
      let disabled = false;

      if (!hasName) disabled = true;
      if (hasChosen) disabled = true;
      if (eliminated) disabled = true;
      if (!lastState || !lastState.roundActive) disabled = true;

      buttons.forEach(b => b.disabled = disabled);
    }
  </script>
</body>
</html>